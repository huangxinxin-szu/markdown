# Raft 协议

一个 Raft 集群中包含 3 种角色：

- Leader
- Candidate
- Follower

一开始时需要进行一次大选，所有参与者都可以参与竞选，所有群众都可以成为候选人，一旦某位候选人得到了半数以上群众的选票，就胜任那一任的领袖，开始一个任期，领袖会昭告天下，结束选举，其他候选人又回到群众身份并接受领袖的领导。

领导人拥有至高无上的权力，负责管理复制日志来维护节点间复制日志的一致性， 数据都是单向地从领导人流向其他服务器。


## 选举
### 心跳和选举计时器

选举中有两个很重要的概念：心跳和选举计时器

每个节点都会有一个选举计时器，Leader 在任期内必须定期向集群内的其他节点广播心跳包，昭告自己的存在， Follower 每次收到心跳包后就会主动将自己的选举定时器重置，如果选举定时器超时，则意味着在规定的一个选举超时时间周期内，Leader 的心跳包没有发给 Follower，Follower 就假定 Leader 已经不存在或者发送了故障，于是会发起一次新的选举

### 选举的过程

如果一个 Follower 决定开始参加选举，那么它会执行如下步骤：

- 将自己本地维护的当前任期号 current_term_id 加1
- 将自己的状态切回 Candidate，并为自己投票，每个 Candidate 的第一张选票来自于他自己
- 向其所在集群中的其他节点发送 RequestVote RPC，要求它们投票给自己

Candidate 有 3 种状态迁移的可能：

- 得到大多数节点的选票，成为 Leader
- 发现其他节点赢得了选举，主动切回 Follower
- 过一段时间发现没人赢得选举，重新发起一次选举

一个 Raft 节点最多只能为一个候选人投票，按照先来先得的原则，投给最早来拉票的候选人。

在参与选举时，候选人可能会收到来自其他节点声称自己的 Leader 的心跳包（空的 AppendEntries RPC），候选人会检查这个心跳包的任期号，如果比自己维护的当前任期要大，则承认该领导人合法，并主动将自己切回 Follower，反之则认为其不合法，拒绝此次 RPC, 并返回当前较新的任期号，以便让该 Leader 意识到自己的任期号已过期了，候选人的身份将保持不变。

如果多个 Follower 在同一时刻成为候选人，那选票就可能被多个候选人平分，使得没有哪个候选人的选票能过半数，此时各个候选人会自增任期号，发起新一轮的拉票活动。为了防止每次选票都被瓜分，选不出 Leader 的情况， Raft 设置了一个随机的选举超时重试区间（150~300ms），使得大多数情况下都会只有一个节点率先超时发起新一轮选举，该节点会在其它节点超时之前赢得选举，并向其它节点发送心跳信息。

### RequestVote RPC

拉票的过程使用 RequestVote RPC,该 RPC 的发起方是候选人，接收方是集群中的所有其它节点

接收方的处理逻辑：

- 如果term<currentTerm，则拒绝投票给该候选人，并提醒该候选人其term过期了
- 如果之前没把票投个任何人或者已经把票投个当前候选人，则告诉候选人票投给他了，如果之前已经把票投给别人了，则不能投票

## Leader 的工作

