



## 从Service说起

```go
type Service struct {
	Name   string         // 服务名称
	Title  string         // 服务标题
	Router []Router       // 路由信息
	Init   []func() error // 额外的初始化函数
	Clean  []func()       // 额外的清理函数
}

type Router struct {
	Path       string                                       `json:"path"`    // 路由匹配路径
	Handler    func(w http.ResponseWriter, r *http.Request) `json:"-"`       // 路由处理函数
	Method     string                                       `json:"method"`  // 处理的请求
	PathPrefix bool                                         `json:"-"`       // 是否使用前缀匹配路由
	Comment    string                                       `json:"comment"` // 注释信息
}
```

启动服务的代码：

```go
func (s Service) Start() {
	// 执行初始化操作
	s.initService()
	httpAddr := ""
	if s.Name == "storage_client" {
		httpAddr = "0.0.0.0:8099"
	} else {
		serviceConfig := conf.GetSvcConfig()
		httpAddr = serviceConfig.IP + ":" + strconv.Itoa(serviceConfig.Port)
	}
	log.Println(s.Title + "服务启动中")
	log.Println("服务地址：http://" + httpAddr)
	// 设置和启动服务
	server := &http.Server{
		Addr:    httpAddr,
		Handler: cors.NewHandler(s.addRouter()),
	}
	errChan := make(chan error, 1)
	go func() {
		errChan <- server.ListenAndServe()
		log.Println(s.Title + "服务停止中")
	}()
	log.Println(s.Title + "服务启动成功")

	// 捕获退出信号
	signalChan := make(chan os.Signal, 1)
	signal.Notify(signalChan, syscall.SIGINT, syscall.SIGTERM)
	ctx := context.Background()
	for {
		select {
		case err := <-errChan:
			if err != nil {
				log.Println(err)
			}
			// 执行额外的清理操作
			for _, clean := range s.Clean {
				clean()
			}
			if commonInit {
				// 关闭数据库客户端
				err := database.CloseDatabase()
				if err != nil {
					log.Println(err)
				}
				// 关闭日志客户端
				log.CloseLog()
			}
			return
		case s := <-signalChan:
			log.Printf("捕获到信号%v，准备停止服务\n", s)
			server.Shutdown(ctx)
		}
	}
}
```

